{% extends "base/auth_base.html" %} {% block title %} Login | FastAPI HTMX {%
endblock %} {% block content %}
<div
  id="login-page"
  x-cloak
  x-data="{  emailInput: '', 
  showEmailError: false, 
  message: '', 
  showError: false, 
  validEmail: false, 
  showEmailError: false, 
  showPasswordInput: false,
  showInputButton: false,
   
  validateEmail() {
    const pattern = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
    if (!pattern.test(this.emailInput)) {
      this.showEmailError = true;
      this.showPasswordInput = false;
    } else if (this.emailInput === '') {
      this.showEmailError = false;
      this.showPasswordInput = false;
    } else {
      this.showEmailError = false;
      this.showPasswordInput = true;
    }
  }
  }"
  x-init="$watch('emailInput', value => validateEmail())
          $watch('showError', value => {
            if (value) {
              setTimeout(() => {
                showError = false;
              }, 3000);
            }
          })"
  class="bg-gray-100 dark:bg-gray-900 flex justify-center items-center h-screen"
>
  <div class="bg-indigo-100 shadow-lg rounded-lg p-8 max-w-md mx-auto w-96">
    <h1
      class="text-2xl font-bold mb-6 text-center"
      style="min-width: 300px; color: #1a56db"
    >
      Admin Dashboard
    </h1>
    <img
      id="login-logo"
      src="/static/img/logo/undraw_login.png"
      alt="Login Logo"
      class="max-w-xs rounded-full opacity-50 shadow-md mb-6"
    />

    <div class="mb-6">
      <label
        for="email"
        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
        >Email address</label
      >
      <input
        type="email"
        id="email"
        name="username"
        x-cloak
        x-model="emailInput"
        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
        placeholder="john.doe@company.com"
        autocomplete="off"
        required
      />
      <p
        id="UsernameError"
        class="hidden mb-2 text-red-600 dark:text-red-500"
        x-bind:class="{ 'hidden': !showEmailError }"
      >
        <span class="font-medium">Please enter a valid email address</span>
      </p>
    </div>
    <div class="mb-4">
      <label
        for="password"
        id="password-label"
        class="hidden block mb-2 text-sm font-medium text-gray-900 dark:text-white"
        >Password</label
      >
      <input
        type="password"
        id="password"
        name="password"
        x-cloak
        x-bind:class="{ 'hidden': !showPasswordInput }"
        @input="showInputButton = $event.target.value.length > 0"
        @keyup.enter="setCookie"
        class="hidden bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
        autocomplete="new-password"
        placeholder="•••••••••"
        required
      />
    </div>
    <p
      x-text="message"
      x-show="showError"
      class="mb-2 text-red-600 dark:text-red-500"
    >
      <span class="font-medium"></span>
    </p>
    <a
      class="text-sm font-medium text-gray-900 dark:text-gray-300 text-center align-middle"
      >Forgot Username/Password</a
    >
    <div class="mt-2">
      <button
        type="submit"
        id="login-button"
        @click="setCookie"
        x-bind:class="{ 'text-white bg-blue-400 dark:bg-blue-500 cursor-not-allowed': !showInputButton, ' text-white bg-blue-700 hover:bg-blue-800': showInputButton }"
        class="text-white bg-blue-700 hover-bg-blue-800 focus-ring-4 focus-outline-none focus-ring-blue-300 font-medium rounded-lg text-sm w-full sm-w-auto px-5 py-2.5 text-center dark-bg-blue-600 dark-hover-bg-blue-700 dark-focus-ring-blue-800"
      >
        Submit
      </button>
    </div>

    <div class="mt-2">
      <button
        type="submit"
        id="create-user-button"
        hx-get="{{ url_for('get_register') }}"
        hx-target="#login-page"
        hx-swap="outerHTML"
        hx-push-url="true"
        class="text-white bg-green-500 hover:bg-green-600 focus-ring-4 focus-outline-none focus-ring-green-300 font-medium rounded-lg text-sm w-full sm-w-auto px-5 py-2.5 text-center dark-bg-green-600 dark-hover-bg-green-700 dark-focus-ring-green-800"
      >
        Register User
      </button>
    </div>
    <script>
      function setCookie() {
        // Get the username and password from the form
        const username = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        const formData = new URLSearchParams();
        formData.append("grant_type", "");
        formData.append("username", username);
        (function (p) {
          formData.append("password", p);
        })(password);
        formData.append("scope", "");
        formData.append("client_id", "");
        formData.append("client_secret", "");
        fetch("/auth/jwt/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: formData,
        })
          .then((response) => {
            if (response.status === 204) {
              // Successful login, navigate to /dashboard
              window.location.href = "/dashboard";
            } else if (response.status === 400) {
              // Incorrect username or password
              this.message = "Incorrect username or password";
              this.showError = true;
              return response.text();
            } else {
              // Handle unexpected status codes
              throw new Error(`Unexpected response status: ${response.status}`);
            }
          })
          .then((errorMessage) => {
            if (errorMessage) {
              Alpine.store("message", "Error: Incorrect username or password");
              console.log(errorMessage);
            }
          })
          .catch((error) => {
            // Handle network errors and other unexpected errors
            this.message = "An error occurred. Please try again later.";
            this.showError = true;
            console.error("Login error:", error);
          });

        Alpine.data("login", () => ({
          setCookie,
        }));
      }
    </script>
    {% endblock %}
  </div>
</div>
